
<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="{% static 'css/styles.css' %}" rel="stylesheet">
  <link href="{% static 'css/window.css' %}" rel="stylesheet">
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet"> 
  <script src="{% static 'js/bootstrap.min.js' %}"></script>
  <script src="{% static 'js/popper.min.js' %}"></script>
  <!-- <script src="{% static 'js/scripts.js' %}" type="text/javascript"></script> -->
  <title>fin</title>
  <style>
    html::-webkit-scrollbar {
        display: none;
    }
    </style>
</head>
<body>
  <div class="container-fluid">
    <nav class="bg-body-tertiary pb-2 floating-nav">
      <h1 style="text-align: center; font-weight: 700;">fin</h1>
      <form autocomplete="off" id="selection-form" enctype="multipart/form-data" action="{% url 'retrieve' %}">
        {% csrf_token %}
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 p-2 align-items-center">
          <div class="col-3">
            <div class="form-floating" style="position: relative; z-index: 1; width: auto;">
              <textarea class="form-control" type="text" id="company_field" placeholder="Enter Company Name" autocomplete="off" spellcheck="false"></textarea>
              <label for="company_field">Company Name</label>
              <!-- <div class="parent-options" id="parent-options">
              </div> -->
            </div>
          </div>
          <div class="col-3">
            <div class="form-floating">
              <select class="form-select" id="YearSelect" aria-label="Select Year">
                <option value="">select Fiscal Year</option>
                <!-- <option value="2024">2024</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option> -->
              </select>
              <label for="YearSelect">Choose Fiscal Year</label>
            </div>
          </div>
          <div class="col-3">
            <div class="form-floating" style="position: relative; z-index: 0; width: auto;">
              <select class="form-select" id="QuarterSelect" aria-label="Select Quarter">
                <option value="">select Quarter</option>
                <!-- <option value="1">One (Q1)</option>
                <option value="2">Two (Q2)</option>
                <option value="3">Three (Q3)</option>
                <option value="4">Four (Q4)</option> -->
              </select>
              <label for="QuarterSelect">Choose Quarter</label>
            </div>
          </div>
          <div class="col-3">
            <div class="form-floating">
              <select class="form-select" id="ServiceSelect" aria-label="Select Service">
                <!-- <option value="">select Service</option> -->
                <option value="1">Summarize</option>
                <!-- <option value="2">Sentiment</option> -->
                <option value="3">Key takeaways</option>
              </select>
              <label for="ServiceSelect">Choose Service</label>
            </div>
          </div>
        </div>
        <button class="btn btn-primary mx-auto" id="submit-btn" type="submit" style="display: block;">Submit</button>
      </form>
    </nav>
    <div id="senti">
      <div class="modal fade" id="sentimentmodal" tabindex="-1" aria-labelledby="sentimentmodalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-2" id="sentimentmodalLabel"></h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="sentiment_sentences">
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="mx-auto" style="z-index: 0; display: block; position: relative;" id="senti_content"></div>
    <div> 
      <div id="display_div" class="row mt-2">
        <div class="col-6 mx-auto p-2" id="pdf_parent"></div>
        <div class="col-6 mx-auto p-2" id="fin_parent"></div>
      </div>
      <div id="status" class="position-absolute start-50 top-50 translate-middle" style="display: block; margin-left: auto; margin-right: auto;"></div>
    </div>
  </div>
</body>

<script>
  var auto_url = "{% url 'autocomplete' %}";
</script>
<script src="{% static 'js/window.js' %}"></script>
<script src="{% static 'js/autocomplete.js' %}"></script>
  <script>
    console.log("Hi");
    companies = null;

    prev_doc = ''; 
    
    let lastScrollY = 0;
    
    window.addEventListener("scroll", function(e) {
      e.preventDefault();
    const floatingDiv = document.querySelector(".floating-nav");
    const displayDiv = document.querySelector("#display_div");
    const currentScrollY = window.scrollY;

    if (currentScrollY > lastScrollY) {
      // Scrolling down
      floatingDiv.classList.add("d-none");
      displayDiv.scrollIntoView({behavior: "smooth", block: "start"});
      // window.scroll(1,0);
      // displayDiv.classList.add("fixed-top");
    } else {
      // Scrolling up
      floatingDiv.classList.remove("d-none");
      // displayDiv.classList.remove("fixed-top");
    }

    // lastScrollY = currentScrollY;
  });

  function growLoader() {
    senti_content.innerHTML = ``;
    document.getElementById("status").innerHTML = `<div class="spinner-grow" style="border-radius: .5px;" role="status">
                                                          <span class="visually-hidden">Loading...</span>
                                                            </div>`;
    if (document.getElementById("fin_text")){
        document.getElementById("fin_text").remove();
        document.getElementById("pdf_doc").remove();}
  }

    var selection_form = document.getElementById('selection-form');
    var qselect = document.getElementById('QuarterSelect');
    var sselect = document.getElementById('ServiceSelect');
    var yselect = document.getElementById('YearSelect');
    var coselect = document.getElementById('company_field');

    ktdata = null;

    
    document.addEventListener("keydown", (e) => {
      if (e.keyCode == 13) {
        if (coselect.value != '') {
          document.getElementById('submit-btn').click();
        }
      }
    });

    qselect.addEventListener("change", (e) => {
      growLoader();
      setTimeout(() => {
        document.getElementById('submit-btn').click();
      }, 2000);
    });

    yselect.addEventListener("change", (e) => {
      growLoader();
      setTimeout(() => {
        document.getElementById('submit-btn').click();
      }, 2000);
    });

    sselect.addEventListener("change", (e) => {
      growLoader();
      setTimeout(() => {
        document.getElementById('submit-btn').click();
    }, 2000);
    });


    document.getElementById('submit-btn').addEventListener('click', function(e) {
      e.preventDefault();
      for (i=0;i<companies.length;i++){
        if (coselect.value===companies[i][0]){
        var cselect = companies[i][1];
        console.log(cselect);
        break;
      }
    }
    // if (cselect != '' && yselect.value != '' && qselect.value != '' && sselect.value != '')
    // {
          // senti.innerHTML=`<span class="loader"></span>`;
          growLoader();
            formdata = new FormData();
            selected = [cselect, yselect.value, qselect.value, sselect.value];
            formdata.append("selected", JSON.stringify(selected));
            fetch(selection_form.action, {
                method: 'POST',
                body: formdata,
            })
            .then(response => response.json())
            .then(data => {
                if (data.errors) {
                    // Handle form validation errors
                    console.log(data.errors);
                } else {
                  console.log(data.status);
                  if (data.status == 200){
                    if (!document.getElementById("fin_text")){
                      if (document.getElementById("status")){document.getElementById("status").innerText = '';}
                      const pdf_elem = document.createElement("embed");
                      pdf_elem.src = "{% static 'documents/' %}"+data.ticker+"/"+data.year+"/"+data.qrtr+"/"+data.ticker+".pdf";
                      // pdf_elem.classList.add("mx-auto");
                      pdf_elem.id = "pdf_doc";
                      pdf_elem.style.height = "97vh";
                      pdf_elem.style.width = "47vw";
                      document.getElementById("pdf_parent").appendChild(pdf_elem);
                      const fin_text = document.createElement("div");
                      fin_text.id = "fin_text";
                      fin_text.style.overflowY = "scroll";
                      fin_text.style.height = "97vh";
                      fin_text.style.border="1px dashed gray;"
                      if (data.ktr == 1){
                        console.log(data.ktdata);
                        ktdata = data.ktdata;
                        ktaways = data.text.split('\n');
                        kthtml = ``;
                        for(i=0;i<ktaways.length;i++){
                          if (i==0){
                            kthtml += `<p>`+ktaways[i]+`</p>`;  
                          }
                          else{
                            kthtml += `<p class="ktaways" onclick="elaborate(this)" data-bs-toggle="modal" data-bs-target="#sentimentmodal" id="ktaways`+i+`">`+ktaways[i]+`</p>`;
                          }
                        }
                        fin_text.innerHTML = kthtml;
                      }
                      else{
                        fin_text.innerText = data.text;
                      }
                      document.getElementById("fin_parent").appendChild(fin_text);
                    }
                    else{
                      pdf_doc.src = "{% static 'documents/' %}"+data.ticker+"/"+data.year+"/"+data.qrtr+"/"+data.ticker+".pdf";
                      fin_text.innerText = data.text;
                    }
                }
                  else{
                    document.getElementById("status").innerHTML = ``;
                    stats = document.getElementById("status");
                    stats.style.textAlign = "center";
                    console.log(data.pdf);
                    if(data.status == 404){
                      stats.innerHTML = `<a>No such company available.</a>`;  
                    }
                    else{
                      go = 0
                      if (data.pdf){
                        // console.log(data.pdf);
                      // for(i=0;i<data.pdfs.length;i++){
                      //   if (data.pdfs[i] != '')
                      //   { go = i; }
                      //   else{
                      //     go = 0;
                      //   }
                      // }
                      // if (go != 0)
                      // {
                        stats.innerHTML = `<a href=`+data.pdf+`>Click to Generate</a>`;
                      // }
                    }
                      else{
                        stats.innerHTML = `<a>PDFs are not available</a>`;
                      }
                    }
                  }
                }
            })
            .catch(error => {
                // Handle any network or server errors
                // console.log("this is the form data:", formdata)
                console.error(error);
              });

            
            sentiform = new FormData();
            selected_s = [cselect, yselect.value, qselect.value];
            sentiform.append("selected", JSON.stringify(selected_s));            
              fetch("{% url 'sentiment' %}", {
                method: 'POST',
                body: sentiform,
            })
            .then(response => response.json())
            .then(data => {
                if (data.status == 404) {
                  console.log(data.errors);
                  senti_content.innerHTML = `<div class="mx-auto p-2" style="display: block; font-size: small;">Setiment data unavilable</div>`;
                }
                else{
                  score = data.score;
                  sarray = score.split("\n");
                  for (i=0;i<sarray.length;i++){
                    sarray[i] = Math.round((sarray[i] * 10000) / 100);
                  }
                  pos = data.pos;
                  neg = data.neg;
                  neu = data.neu;
                  senti_content.innerHTML = `<div class="mx-auto p-2" style="display: block;">Positive: <a class="hyperlink" id="poss" data-bs-toggle="modal" data-bs-target="#sentimentmodal">${sarray[0]}%</a>, Negative: <a class='hyperlink' id="negs" data-bs-toggle="modal" data-bs-target="#sentimentmodal">${sarray[2]}%</a> and Neutral: <a class='hyperlink' id="neus" data-bs-toggle="modal" data-bs-target="#sentimentmodal">${sarray[1]}%</a>`;
                  poss.addEventListener("click", () => {
                    sentimentmodalLabel.innerText = "Sentiment - Positive";
                    sentiment_sentences.innerText = pos;
                  });
                  negs.addEventListener("click", () => {
                    sentimentmodalLabel.innerText = "Sentiment - Negative";
                    sentiment_sentences.innerText = neg;
                  });
                  neus.addEventListener("click", () => {
                    sentimentmodalLabel.innerText = "Sentiment - Neutral";
                    sentiment_sentences.innerText = neu;
                  });
                  // console.log(data);
                }
              })
              .catch(error =>{
                console.error(error);
              });
        // }
        // else {
        //   alert("Must make selections for each of the criteria")
        // }
        });
    
    function elaborate(elem){
      id = parseInt(elem.id.slice(7));
      sentimentmodalLabel.innerText = "Elaborated";
      sentiment_sentences.innerText = ktdata[id-2];

    }    
  </script>
</html>