
<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="{% static 'css/styles.css' %}" rel="stylesheet">
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet"> 
  <script src="{% static 'js/bootstrap.min.js' %}"></script>
  <script src="{% static 'js/popper.min.js' %}"></script>
  <!-- <script src="{% static 'js/scripts.js' %}" type="text/javascript"></script> -->
  <title>fin</title>
  <style>
    html::-webkit-scrollbar {
        display: none;
    }
    </style>
</head>
<body>
  <div class="container-fluid">
    <nav class="bg-body-tertiary pb-2 floating-nav">
      <h1 style="text-align: center; font-weight: 700;">fin</h1>
      <form autocomplete="off" id="selection-form" enctype="multipart/form-data" action="{% url 'retrieve' %}">
        {% csrf_token %}
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 p-2 align-items-center">
          <div class="col-3">
            <div class="form-floating" style="position: relative; z-index: 1; width: auto;">
              <textarea class="form-control" type="text" id="company_field" placeholder="Enter Company Name" autocomplete="off" spellcheck="false"></textarea>
              <label for="company_field">Company Name</label>
              <!-- <div class="parent-options" id="parent-options">
              </div> -->
            </div>
          </div>
          <div class="col-3">
            <div class="form-floating">
              <select class="form-select" id="YearSelect" aria-label="Select Year">
                <option value="">select Fiscal Year</option>
                <!-- <option value="2024">2024</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option> -->
              </select>
              <label for="YearSelect">Choose Fiscal Year</label>
            </div>
          </div>
          <div class="col-3">
            <div class="form-floating" style="position: relative; z-index: 0; width: auto;">
              <select class="form-select" id="QuarterSelect" aria-label="Select Quarter">
                <option value="">select Quarter</option>
                <!-- <option value="1">One (Q1)</option>
                <option value="2">Two (Q2)</option>
                <option value="3">Three (Q3)</option>
                <option value="4">Four (Q4)</option> -->
              </select>
              <label for="QuarterSelect">Choose Quarter</label>
            </div>
          </div>
          <div class="col-3">
            <div class="form-floating">
              <select class="form-select" id="ServiceSelect" aria-label="Select Service">
                <!-- <option value="">select Service</option> -->
                <option value="1">Summarize</option>
                <!-- <option value="2">Sentiment</option> -->
                <option value="3">Key takeaways</option>
              </select>
              <label for="ServiceSelect">Choose Service</label>
            </div>
          </div>
        </div>
        <button class="btn btn-primary mx-auto" id="submit-btn" type="submit" style="display: block;">Submit</button>
      </form>
    </nav>
    <div id="senti">
      <div class="modal fade" id="sentimentmodal" tabindex="-1" aria-labelledby="sentimentmodalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-2" id="sentimentmodalLabel"></h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="sentiment_sentences">
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="mx-auto" style="z-index: 0; display: block; position: relative;" id="senti_content"></div>
    <div> 
      <div id="display_div" class="row mt-2">
        <div class="col-6 mx-auto p-2" id="pdf_parent"></div>
        <div class="col-6 mx-auto p-2" id="fin_parent"></div>
      </div>
      <div id="status" class="position-absolute start-50 top-50 translate-middle" style="display: block; margin-left: auto; margin-right: auto;"></div>
    </div>
  </div>
</body>


  <script>
    console.log("Hi");
    // var companies = "{{ cdict|escapejs|safe }}";
    // companies = companies.replace(/(?<=\[)'|'(?=\])|'(?=,)/g, '"');
    // companies = companies.replace(/(?<=,)[^']'/g,' "');
    // companies = companies.replace(/\\xa0/,' ');
    // companies = JSON.parse(companies);
    // console.log(companies);

    
  //   document.getElementById("company_field").addEventListener("click", function(e)
  //   {this.value='';
  // });
    // document.getElementById("company_field").addEventListener("blur", function(e)
    // {
    //   senti_content.style.display  = '';
    // });
    
    // document.getElementById("company_field").addEventListener("focus", function(e)
    // {
    //   senti_content.style.display  = 'none';
    //   if(this.value=''){
    //   closeAllLists();
    // }});

    
      companies = null;

    /*
    autocomplete company names
    */
    let controller = null;
    function get_arr(val){
      if (controller) {
        controller.abort();
        controller = null;
      }

      controller = new AbortController();

      formdata = new FormData();
      formdata.append("nameval", val);
      return fetch("{% url 'autocomplete' %}", {
                method: 'POST',
                body: formdata,
                signal: controller.signal
            })
            .then(response => response.json())
            .then(data => {
              return data.cdict;
            })
            .catch(error => {
              console.error(error);
            });
            // .finally(() => {
            //   controller = null;
            // })

    }
    // let arr = null;
    // get_arr("tat").then(result =>{
    //   arr = result;
    //   console.log(arr);
    // });
    
    function autocomplete(inp, year, quar) {
      /*the function has three arguments the textarea, the select element for the year and the select element for the quarter.*/
    var currentFocus;
    // a = document.getElementById('parent-options');
    /*execute a function when someone writes in the text field:*/
    inp.addEventListener("input", function(e) {
        var b, i, val = this.value;
        /*close any already open lists of autocompleted values*/
        if (!val) { 
          closeAllLists();
          return false;
        }
        currentFocus = -1;
        if (val!=''){
        get_arr(val).then(result => {
          closeAllLists();
          if (!val) { 
          closeAllLists();
          return false;
        }
          arr = result;
          companies = result;
        /*create a DIV element that will contain the items (values):*/
        a = document.createElement("div");
        a.id="parent-options";
        a.classList.add("parent-options");
        a.style.zIndex = "1000";
        /*append the DIV element as a child of the autocomplete container:*/
        this.parentNode.appendChild(a);
        /*for each item in the array...*/
        for (i = 0; i < arr.length; i++) {
          /*check if the item starts with the same letters as the t ext field value:*/
          // if (arr[i][0].substr(0, val.length).toUpperCase() == val.toUpperCase() || arr[i][1].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
            /*create a DIV element for each matching element:*/
            b = document.createElement("div");
            b.classList.add("options");
            /*make the matching letters bold:*/
            // b.innerHTML = "<strong>" + arr[i][0].substr(0, val.length) + "</strong>";
            // b.innerHTML += arr[i][0].substr(val.length);
            b.innerHTML = arr[i][0];
            b.innerHTML += " ("+arr[i][1]+")";
            /*insert a input field that will hold the current array item's value:*/
            b.innerHTML += "<input type='hidden' value='" + arr[i][0] + "'>";
            /*execute a function when someone clicks on the item value (DIV element):*/
            b.addEventListener("click", function(e) {
              /*insert the value for the autocomplete text field:*/
              inp.value = this.getElementsByTagName("input")[0].value;
              for(j=0;j<arr.length;j++){
                if (this.getElementsByTagName("input")[0].value == arr[j][0]){
                  tarr = [];
                  tarr.push(arr[j][2]);
                  for (l=0;l<arr[j][4].length;l++){
                  tarr.push(arr[j][4][l]);}
                  console.log(tarr);
                  tarr.sort(function(a, b) {
                      return b - a;
                  });
                  while (year.firstChild) {
                      year.removeChild(year.firstChild);
                  }
                  for (k=0;k<tarr.length;k++){
                    if (tarr[k-1]!=tarr[k]){
                    var option = document.createElement("option");
                    option.text = tarr[k]; // Set text for each option
                    option.value = tarr[k];
                    year.appendChild(option);}
                  }
                  while (quar.firstChild) {
                        quar.removeChild(quar.firstChild);
                    }
                  var loption = document.createElement("option");
                  
                    if (arr[j][3] == 1){
                      loption.text = "One (Q1)"; // Set text for each option
                      loption.value = arr[j][3];}
                    else if (arr[j][3] == 2){
                      loption.text = "Two (Q2)"; // Set text for each option
                      loption.value = arr[j][3];}
                    else if (arr[j][3] == 3){
                      loption.text = "Three (Q3)"; // Set text for each option
                      loption.value = arr[j][3];}
                    else if (arr[j][3] == 4){
                      loption.text = "Four (Q4)"; // Set text for each option
                      loption.value = arr[j][3];}
                    quar.appendChild(loption)
                
                    qn = [1,2,3,4];
                    for(m=0;m<qn.length;m++){
                      if(arr[j][3]==qn[m]){
                        qn.splice(m, 1);
                        i--;
                      }}
                    for(m=0;m<qn.length;m++){
                      var option = document.createElement("option");
                      if (qn[m] == 1){
                        option.text = "One (Q1)"; // Set text for each option
                        option.value = qn[m];}
                      else if (qn[m] == 2){
                        option.text = "Two (Q2)"; // Set text for each option
                        option.value = qn[m];}
                      else if (qn[m] == 3){
                        option.text = "Three (Q3)"; // Set text for each option
                        option.value = qn[m];}
                      else if (qn[m] == 4){
                        option.text = "Four (Q4)"; // Set text for each option
                        option.value = qn[m];}
                      quar.appendChild(option)
                    }    
                }
            }
              // var opt = 
              // year
              // console.log(inp.value);
              /*close the list of autocompleted values,
              (or any other open lists of autocompleted values:*/
              closeAllLists();
              document.getElementById('submit-btn').click();
            });
            a.appendChild(b);
            // }
          }
        })
        .then(() => {
          const keydown = new KeyboardEvent('keydown', {
            keyCode: 40});
          inp.dispatchEvent(keydown);
        });
      }
    });
    /*execute a function presses a key on the keyboard:*/
    inp.addEventListener("keydown", function(e) {
        var y = document.getElementById('parent-options');
        if (y) x = y.getElementsByTagName("div");
        if (e.keyCode == 40) {
          e.preventDefault();
          /*If the arrow DOWN key is pressed,
          increase the currentFocus variable:*/
          console.log(currentFocus);
          currentFocus++;
          /*and and make the current item more visible:*/
          addActive(x);
          console.log(x[currentFocus].offsetTop);
          console.log(y.offsetTop);
          y.scrollTop = x[currentFocus].offsetTop - y.offsetTop;
        } else if (e.keyCode == 38) { //up
          e.preventDefault();
          /*If the arrow UP key is pressed,
          decrease the currentFocus variable:*/
          currentFocus--;
          /*and and make the current item more visible:*/
          addActive(x);
          y.scrollTop = x[currentFocus].offsetTop - y.offsetTop;
        } else if (e.keyCode == 13) {
          /*If the ENTER key is pressed, prevent the form from being submitted,*/
          e.preventDefault();
          if (currentFocus > -1) {
            /*and simulate a click on the "active" item:*/
            if (x) x[currentFocus].click();
          }
        }
    });


    function addActive(x) {
      /*a function to classify an item as "active":*/
      if (!x) return false;
      /*start by removing the "active" class on all items:*/
      removeActive(x);
      if (currentFocus >= x.length) currentFocus = x.length-1;
      if (currentFocus < 0) currentFocus = (x.length - 1);
      /*add class "autocomplete-active":*/
      x[currentFocus].classList.add("options-active");
    }
    function removeActive(x) {
      /*a function to remove the "active" class from all autocomplete items:*/
      for (var i = 0; i < x.length; i++) {
        x[i].classList.remove("options-active");
      }
    }
    function closeAllLists(elmnt) {
      /*close all autocomplete lists in the document,
      except the one passed as an argument:*/
      var x = document.getElementsByClassName("parent-options");
      for (var i = 0; i < x.length; i++) {
        if (elmnt != x[i] && elmnt != inp) {
        x[i].parentNode.removeChild(x[i]);
      }
    }
  }
  /*execute a function when someone clicks in the document:*/
  document.addEventListener("click", function (e) {
      closeAllLists(e.target);
  });
}

  
  
  // the rest  
  autocomplete(document.getElementById("company_field"), document.getElementById("YearSelect"), document.getElementById("QuarterSelect"));

    prev_doc = ''; 
    
    let lastScrollY = 0;
    
    window.addEventListener("scroll", function(e) {
      e.preventDefault();
    const floatingDiv = document.querySelector(".floating-nav");
    const displayDiv = document.querySelector("#display_div");
    const currentScrollY = window.scrollY;

    if (currentScrollY > lastScrollY) {
      // Scrolling down
      floatingDiv.classList.add("d-none");
      displayDiv.scrollIntoView({behavior: "smooth", block: "start"});
      // window.scroll(1,0);
      // displayDiv.classList.add("fixed-top");
    } else {
      // Scrolling up
      floatingDiv.classList.remove("d-none");
      // displayDiv.classList.remove("fixed-top");
    }

    // lastScrollY = currentScrollY;
  });

  function growLoader() {
    senti_content.innerHTML = ``;
    document.getElementById("status").innerHTML = `<div class="spinner-grow" style="border-radius: .5px;" role="status">
                                                          <span class="visually-hidden">Loading...</span>
                                                            </div>`;
    if (document.getElementById("fin_text")){
        document.getElementById("fin_text").remove();
        document.getElementById("pdf_doc").remove();}
  }

    var selection_form = document.getElementById('selection-form');
    var qselect = document.getElementById('QuarterSelect');
    var sselect = document.getElementById('ServiceSelect');
    var yselect = document.getElementById('YearSelect');
    var coselect = document.getElementById('company_field');

    ktdata = null;

    
    document.addEventListener("keydown", (e) => {
      if (e.keyCode == 13) {
        if (coselect.value != '') {
          document.getElementById('submit-btn').click();
        }
      }
    });

    qselect.addEventListener("change", (e) => {
      growLoader();
      setTimeout(() => {
        document.getElementById('submit-btn').click();
      }, 2000);
    });

    yselect.addEventListener("change", (e) => {
      growLoader();
      setTimeout(() => {
        document.getElementById('submit-btn').click();
      }, 2000);
    });

    sselect.addEventListener("change", (e) => {
      growLoader();
      setTimeout(() => {
        document.getElementById('submit-btn').click();
    }, 2000);
    });


    document.getElementById('submit-btn').addEventListener('click', function(e) {
      e.preventDefault();
      for (i=0;i<companies.length;i++){
        if (coselect.value===companies[i][0]){
        var cselect = companies[i][1];
        console.log(cselect);
        break;
      }
    }
    // if (cselect != '' && yselect.value != '' && qselect.value != '' && sselect.value != '')
    // {
          // senti.innerHTML=`<span class="loader"></span>`;
          growLoader();
            formdata = new FormData();
            selected = [cselect, yselect.value, qselect.value, sselect.value];
            formdata.append("selected", JSON.stringify(selected));
            fetch(selection_form.action, {
                method: 'POST',
                body: formdata,
            })
            .then(response => response.json())
            .then(data => {
                if (data.errors) {
                    // Handle form validation errors
                    console.log(data.errors);
                } else {
                  console.log(data.status);
                  if (data.status == 200){
                    if (!document.getElementById("fin_text")){
                      if (document.getElementById("status")){document.getElementById("status").innerText = '';}
                      const pdf_elem = document.createElement("embed");
                      pdf_elem.src = "{% static 'documents/' %}"+data.ticker+"/"+data.year+"/"+data.qrtr+"/"+data.ticker+".pdf";
                      // pdf_elem.classList.add("mx-auto");
                      pdf_elem.id = "pdf_doc";
                      pdf_elem.style.height = "97vh";
                      pdf_elem.style.width = "47vw";
                      document.getElementById("pdf_parent").appendChild(pdf_elem);
                      const fin_text = document.createElement("div");
                      fin_text.id = "fin_text";
                      fin_text.style.overflowY = "scroll";
                      fin_text.style.height = "97vh";
                      fin_text.style.border="1px dashed gray;"
                      if (data.ktr == 1){
                        console.log(data.ktdata);
                        ktdata = data.ktdata;
                        ktaways = data.text.split('\n');
                        kthtml = ``;
                        for(i=0;i<ktaways.length;i++){
                          if (i==0){
                            kthtml += `<p>`+ktaways[i]+`</p>`;  
                          }
                          else{
                            kthtml += `<p class="ktaways" onclick="elaborate(this)" data-bs-toggle="modal" data-bs-target="#sentimentmodal" id="ktaways`+i+`">`+ktaways[i]+`</p>`;
                          }
                        }
                        fin_text.innerHTML = kthtml;
                      }
                      else{
                        fin_text.innerText = data.text;
                      }
                      document.getElementById("fin_parent").appendChild(fin_text);
                    }
                    else{
                      pdf_doc.src = "{% static 'documents/' %}"+data.ticker+"/"+data.year+"/"+data.qrtr+"/"+data.ticker+".pdf";
                      fin_text.innerText = data.text;
                    }
                }
                  else{
                    document.getElementById("status").innerHTML = ``;
                    stats = document.getElementById("status");
                    stats.style.textAlign = "center";
                    console.log(data.pdf);
                    if(data.status == 404){
                      stats.innerHTML = `<a>No such company available.</a>`;  
                    }
                    else{
                      go = 0
                      if (data.pdf){
                        // console.log(data.pdf);
                      // for(i=0;i<data.pdfs.length;i++){
                      //   if (data.pdfs[i] != '')
                      //   { go = i; }
                      //   else{
                      //     go = 0;
                      //   }
                      // }
                      // if (go != 0)
                      // {
                        stats.innerHTML = `<a href=`+data.pdf+`>Click to Generate</a>`;
                      // }
                    }
                      else{
                        stats.innerHTML = `<a>PDFs are not available</a>`;
                      }
                    }
                  }
                }
            })
            .catch(error => {
                // Handle any network or server errors
                // console.log("this is the form data:", formdata)
                console.error(error);
              });

            
            sentiform = new FormData();
            selected_s = [cselect, yselect.value, qselect.value];
            sentiform.append("selected", JSON.stringify(selected_s));            
              fetch("{% url 'sentiment' %}", {
                method: 'POST',
                body: sentiform,
            })
            .then(response => response.json())
            .then(data => {
                if (data.status == 404) {
                  console.log(data.errors);
                  senti_content.innerHTML = `<div class="mx-auto p-2" style="display: block; font-size: small;">Setiment data unavilable</div>`;
                }
                else{
                  score = data.score;
                  sarray = score.split("\n");
                  for (i=0;i<sarray.length;i++){
                    sarray[i] = Math.round((sarray[i] * 10000) / 100);
                  }
                  pos = data.pos;
                  neg = data.neg;
                  neu = data.neu;
                  senti_content.innerHTML = `<div class="mx-auto p-2" style="display: block;">Positive: <a class="hyperlink" id="poss" data-bs-toggle="modal" data-bs-target="#sentimentmodal">${sarray[0]}%</a>, Negative: <a class='hyperlink' id="negs" data-bs-toggle="modal" data-bs-target="#sentimentmodal">${sarray[2]}%</a> and Neutral: <a class='hyperlink' id="neus" data-bs-toggle="modal" data-bs-target="#sentimentmodal">${sarray[1]}%</a>`;
                  poss.addEventListener("click", () => {
                    sentimentmodalLabel.innerText = "Sentiment - Positive";
                    sentiment_sentences.innerText = pos;
                  });
                  negs.addEventListener("click", () => {
                    sentimentmodalLabel.innerText = "Sentiment - Negative";
                    sentiment_sentences.innerText = neg;
                  });
                  neus.addEventListener("click", () => {
                    sentimentmodalLabel.innerText = "Sentiment - Neutral";
                    sentiment_sentences.innerText = neu;
                  });
                  // console.log(data);
                }
              })
              .catch(error =>{
                console.error(error);
              });
        // }
        // else {
        //   alert("Must make selections for each of the criteria")
        // }
        });
    
    function elaborate(elem){
      id = parseInt(elem.id.slice(7));
      sentimentmodalLabel.innerText = "Elaborated";
      sentiment_sentences.innerText = ktdata[id-2];

    }    
  </script>
</html>