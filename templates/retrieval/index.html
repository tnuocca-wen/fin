
<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet"> 
  <link href="{% static 'css/styles.css' %}" rel="stylesheet">
  <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
  <!-- <script src="{% static 'js/scripts.js' %}" type="text/javascript"></script> -->
  <script src="{% static js/pdf.js %}" type="module"></script>
  <title>fin</title>
  <style>
    html::-webkit-scrollbar {
        display: none;
    }
    </style>
</head>
<body>
  <div class="container-fluid">
    <nav class="bg-body-tertiary pb-2 floating-nav">
    <h1 style="text-align: center; font-weight: 700;">fin</h1>
    <form id="selection-form" enctype="multipart/form-data" action="{% url 'retrieve' %}">
      {% csrf_token %}
    <div class="row p-2 justify-content-center">
        <div class="col-3">
          <div class="form-floating">
            <select class="form-select" id="CompanySelect" aria-label="Select Company">
              {% if cdict %}
              <option value="">Select a company...</option>
                {% for t,n in cdict.items %}
                <option value="{{t}}">{{n}}</option>
                {% endfor %}
              {% else %}
              <option value="">Company List not Available</option>
              {% endif %}
            </select>
            <label for="CompanySelect">Choose Company</label>
          </div>
        </div>
        <div class="col-3">
          <div class="form-floating">
            <select class="form-select" id="QuarterSelect" aria-label="Select Quarter">
                <option value="">select Quarter</option>
                <option value="1">One (Q1)</option>
                <option value="2">Two (Q2)</option>
                <option value="3">Three (Q3)</option>
                <option value="4">Four (Q4)</option>
            </select>
            <label for="QuarterSelect">Choose Quarter</label>
          </div>
        </div>
        <div class="col-3">
          <div class="form-floating">
            <select class="form-select" id="ServiceSelect" aria-label="Select Quarter">
                <option value="">select Service</option>
                <option value="1">Summarize</option>
                <option value="2">Sentiment</option>
                <option value="3">Translate</option>
            </select>
            <label for="ServiceSelect">Choose Service</label>
          </div>
        </div>
      </div>
      <button class="btn btn-primary mx-auto" id="submit-btn" type="submit" style="display: block;">Submit</button>
    </form>
    </nav>
  <div>
    <div id="status"></div>
    <div id="display_div" class="row mt-2">
      <div class="col-6 mx-auto p-2" id="pdf_parent"></div>
      <div class="col-6 mx-auto p-2" id="fin_parent"></div>
    </div>
  </div>
  </div>






  <script>
    console.log("Hi");
    prev_doc = '';

    let lastScrollY = 0;

    window.addEventListener("scroll", function(e) {
      // e.preventDefault();
    const floatingDiv = document.querySelector(".floating-nav");
    const displayDiv = document.querySelector("#display_div");
    const currentScrollY = window.scrollY;

    if (currentScrollY > lastScrollY) {
      // Scrolling down
      floatingDiv.classList.add("d-none");
      window.scroll(0,1);
      // displayDiv.classList.add("fixed-top");
    } else {
      // Scrolling up
      floatingDiv.classList.remove("d-none");
      // displayDiv.classList.remove("fixed-top");
    }

    // lastScrollY = currentScrollY;
  });

    var selection_form = document.getElementById('selection-form');
    var cselect = document.getElementById('CompanySelect');
    var qselect = document.getElementById('QuarterSelect');
    var sselect = document.getElementById('ServiceSelect');
      document.getElementById('submit-btn').addEventListener('click', function(e) {
        e.preventDefault();
        if (cselect.value != '' && qselect.value != '' && sselect.value != '')
        {
            if (document.getElementById("fin_text")){
              document.getElementById("fin_text").remove();
              document.getElementById("pdf_doc").remove();}
            formdata = new FormData();
            selected = [cselect.value, qselect.value, sselect.value];
            formdata.append("selected", JSON.stringify(selected))
            console.log(selected)
            fetch(selection_form.action, {
                method: 'POST',
                body: formdata,
            })
            .then(response => response.json())
            .then(data => {
                if (data.errors) {
                    // Handle form validation errors
                    console.log(data.errors);
                } else {
                  console.log(data.status);
                  if (data.status != 404){
                    if (!document.getElementById("fin_text")){
                      if (document.getElementById("status")){document.getElementById("status").innerText = '';}
                      const pdf_elem = document.createElement("embed");
                      pdf_elem.src = "{% static 'documents/' %}"+data.ticker+"/"+data.qrtr+"/"+data.ticker+".pdf";
                      // pdf_elem.classList.add("mx-auto");
                      pdf_elem.id = "pdf_doc";
                      pdf_elem.style.height = "97vh";
                      pdf_elem.style.width = "47vw";
                      document.getElementById("pdf_parent").appendChild(pdf_elem);
                      const fin_text = document.createElement("div");
                      fin_text.id = "fin_text";
                      fin_text.style.overflowY = "scroll";
                      fin_text.style.height = "97vh";
                      fin_text.innerText = data.text;
                      document.getElementById("fin_parent").appendChild(fin_text);
                    }
                    else{
                      pdf_doc.src = "{% static 'documents/' %}"+data.ticker+"/"+data.qrtr+"/"+data.ticker+".pdf";
                      fin_text.innerText = data.text;
                    }
                }
                  else{
                    stats = document.getElementById("status");
                    stats.style.textAlign = "center";
                    stats.innerText = "Data Unavailable";
                  }
                }
            })
            .catch(error => {
                // Handle any network or server errors
                console.log("this is the form data:", formdata)
                console.error(error);
              });
        }
        else {
          alert("Must make selections for each of the criteria")
        }
        });
  </script>
</body>
</html>